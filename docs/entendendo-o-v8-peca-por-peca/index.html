<!DOCTYPE html><html lang="pt-br"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.93e98014188ca290b204.css">code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;font-family:Fira Code,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2e3440}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#636f88}.token.punctuation{color:#81a1c1}.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#81a1c1}.token.number{color:#b48ead}.token.boolean{color:#81a1c1}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a3be8c}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#81a1c1}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#88c0d0}.token.keyword{color:#81a1c1}.token.important,.token.regex{color:#ebcb8b}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.19.7"/><title data-react-helmet="true">Entendendo o V8 peça por peça | Blog » Gabriel Ramos</title><meta data-react-helmet="true" name="description" content="Lugar onde eu rabisco umas ideias."/><meta data-react-helmet="true" property="og:title" content="Entendendo o V8 peça por peça"/><meta data-react-helmet="true" property="og:description" content="Lugar onde eu rabisco umas ideias."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@gabrieluizramos"/><meta data-react-helmet="true" name="twitter:title" content="Entendendo o V8 peça por peça"/><meta data-react-helmet="true" name="twitter:description" content="Lugar onde eu rabisco umas ideias."/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#000000"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><style data-styled="" data-styled-version="5.0.1">.bTosot{width:100%;max-width:1200px;margin:0 auto;padding:0 30px;}
data-styled.g1[id="styles__Wrapper-fuhlvh-0"]{content:"bTosot,"}
.fMjLLg{margin:0 auto;text-align:center;padding:45px 0;}
data-styled.g2[id="styles__Header-sc-1ipos3n-0"]{content:"fMjLLg,"}
.gEBFEC{font-size:24px;margin-bottom:7.5px;}
data-styled.g3[id="styles__Title-sc-1ipos3n-1"]{content:"gEBFEC,"}
.iEJyaJ{font-size:18px;}
data-styled.g4[id="styles__Subtitle-sc-1ipos3n-2"]{content:"iEJyaJ,"}
.judbns{margin:0 auto;text-align:center;padding:45px 0;font-size:12px;}
data-styled.g5[id="styles__Footer-sc-120opzy-0"]{content:"judbns,"}
.hqYxKk{padding:15px 0;text-align:right;}
.hqYxKk a{color:#696ac6;}
data-styled.g6[id="styles__Back-sc-4tdsl6-0"]{content:"hqYxKk,"}
.gZhOCm{padding:15px 0;}
data-styled.g7[id="styles__PostArticle-sc-4tdsl6-1"]{content:"gZhOCm,"}
.hzsudE{font-size:24px;margin-bottom:7.5px;}
data-styled.g9[id="styles__PostTitle-sc-4tdsl6-3"]{content:"hzsudE,"}
.bVaxMX{color:#4fb06e;font-size:14px;font-weight:normal;}
data-styled.g10[id="styles__PostSubtitle-sc-4tdsl6-4"]{content:"bVaxMX,"}
.hthfqL p,.hthfqL h1,.hthfqL h2,.hthfqL h3,.hthfqL h4,.hthfqL h5,.hthfqL h6,.hthfqL ul,.hthfqL ol,.hthfqL figure,.hthfqL image{margin-bottom:15px;}
.hthfqL li{padding-left:15px;}
.hthfqL li:before{content:'•';font-weight:bold;display:inline-block;margin-right:7.5px;color:#696ac6;}
data-styled.g11[id="styles__PostContent-sc-4tdsl6-5"]{content:"hthfqL,"}
@import url('https://fonts.googleapis.com/css?family=Fira+Code:300,400,500,600,700&display=swap');
html,body{height:100%;background:#000;color:#FFF;}
*{margin:0;padding:0;border:none;-webkit-text-decoration:none;text-decoration:none;list-style:none;vertical-align:baseline;box-sizing:border-box;z-index:0;font-family:'Fira Code',monospace,arial;outline:none;}
a{color:#006cad;}
hr{display:block;width:100%;height:2px;background:linear-gradient(to right,transparent 25%,#1f1e1e 25%,#1f1e1e 75%,transparent 75%);background-size:15px;margin:30px 0;}
data-styled.g17[id="sc-global-kkpSfQ1"]{content:"sc-global-kkpSfQ1,"}
</style><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/component---src-templates-post-index-js-0b61b518c22554eaa13a.js"/><link as="script" rel="preload" href="/commons-ba97eb09b11e7d7faa5b.js"/><link as="script" rel="preload" href="/app-e93772700260c9e23128.js"/><link as="script" rel="preload" href="/styles-07192a3d34f1eb369acc.js"/><link as="script" rel="preload" href="/webpack-runtime-927d743ab403ea495ffe.js"/><link as="fetch" rel="preload" href="/page-data/post/entendendo-o-v8-peca-por-peca/page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><header class="styles__Header-sc-1ipos3n-0 fMjLLg"><h1 class="styles__Title-sc-1ipos3n-1 gEBFEC">Gabriel / Ramos</h1><h2 class="styles__Subtitle-sc-1ipos3n-2 iEJyaJ">⟨ desenvolvedor web ⟩</h2></header><hr/><main class="styles__Wrapper-fuhlvh-0 bTosot"><div class="styles__Back-sc-4tdsl6-0 hqYxKk"><a href="/blog">Voltar</a></div><article class="styles__PostArticle-sc-4tdsl6-1 gZhOCm"><header class="styles__PostHeader-sc-4tdsl6-2 leBvhO"><h1 class="styles__PostTitle-sc-4tdsl6-3 hzsudE">Entendendo o V8 peça por peça</h1><h2 class="styles__PostSubtitle-sc-4tdsl6-4 bVaxMX">23/09/2019</h2></header><hr/><div class="styles__PostContent-sc-4tdsl6-5 hthfqL blog-post-content"><p>Há um tempo venho me interessado e dedicado um tempo a estudar como os motores ("engines") de <strong>JavaScript</strong> funcionam por debaixo dos panos. Resolvi agrupar o que entendi em um artigo para elucidar todos os componentes envolvidos nessa trama toda. Tenha em mente que a maioria desses estudos e conteúdos baseiam-se no V8, motor utilizado pelo NodeJS e Google Chrome. O que não deve se diferenciar (muito) dos motores utilizados em outros navegadores.</p>
<hr>
<h2>Uma pincelada sobre estruturas de dados</h2>
<p>Antes de começar a entender como um motor <strong>JavaScript</strong> funciona, é importante ter um breve conhecimento sobre algumas estruturas de dados envolvidas no processo: <strong>pilha</strong> e <strong>fila</strong>.</p>
<h3>Pilha</h3>
<p>Uma <strong>pilha</strong> segue o princípio chamado <strong>LIFO</strong>: "last-in, first-out", que quer dizer que o último valor a ser inserido em uma <strong>pilha</strong>, deverá ser o primeiro a ser retirado.</p>
<p>Para ficar mais fácil de entender, pense em uma pilha de roupas: você não consegue simplesmente puxar uma roupa de uma pilha sem antes remover as que estão em cima, pois elas cairiam.</p>
<h3>Fila</h3>
<p>Já a <strong>fila</strong> segue outro princípio, chamado <strong>FIFO</strong>: "first-in, first-out", onde o primeiro valor a entrar numa fila, deverá ser o primeiro a ser retirado.</p>
<p>Uma <strong>fila</strong> se assemelha às filas que encontramos em super-mercados, bancos ou shows, onde você é atendido por ordem de chegada e não é correto alguma pessoa ser atendida antes de qualquer outra que já estava ali anteriormente (tirando os casos onde existem filas preferenciais).</p>
<p>Você pode pensar em ambas as estruturas de dados como <strong>arrays</strong> com comportamentos específicos, onde na <strong>pilha</strong> os últimos valores a entrarem nesse <strong>array</strong> serão os primeiros a serem removidos e em uma <strong>fila</strong> seguirão a ordem de entrada, onde os primeiros valores serão os primeiros a serem removidos.</p>
<h3>Heap</h3>
<p>É uma estrutura de dados não-linear, assemelha-se muito à estrutura de <strong>árvore</strong> (ou "<strong>tree</strong>") e não segue uma ordem predeterminada, como na <strong>pilha</strong> e na <strong>fila</strong>, onde a inserção e remoção segue um padrão específico.</p>
<hr>
<h2>Alocação de memória e contextos de execução</h2>
<p>O <strong>JavaScript</strong> aloca/libera memória automaticamente (em uma estrutura de <strong>Heap</strong>), diferente de linguagens de "baixo nível" como <strong>C</strong> que permitem gerenciar memória e alocação de forma mais explícita. Em outras palavras, <strong>JavaScript</strong> aloca memória quando valores/objetos são declarados e alterados e libera esse espaço de memória automaticamente quando esses valores não são mais utilizados, deixando essa responsabilidade a cargo do <strong>garbage collector</strong>. Mesmo assim, é importante manter-se sempre atento aos possíveis valores que você declara/instancia para que não fiquem alocados de forma global ou apontem para objetos que não são utilizados, previnindo eventuais vazamento de memória ("<strong>memory leaks</strong>").</p>
<p>Quando você executa um <strong>script</strong> ou uma <strong>função</strong>, o motor do <strong>JavaScript</strong> compila e interpreta o código em tempo de execução (também conhecido como <strong>JIT</strong> ou just-in-time compilation) e cria determinados contextos e espaços de memória onde esse código é executado. Você pode pensar nesses contextos como os escopos onde sua função pode ser executada.</p>
<p>Vamos criar um trecho de código para exemplificar melhor:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> numero <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">multiplica</span> <span class="token punctuation">(</span><span class="token parameter">numero</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> numero <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Quando esse trecho de código é executado via <strong>JavaScript</strong>, os seguintes passos ocorrem:</p>
<ul>
<li>a variável <strong>numero</strong> é registrada com o valor 10</li>
<li>a função <strong>multiplica</strong> é registrada o seu valor de função</li>
</ul>
<p><strong>Mas como assim, valor de função?</strong>
<strong>JavaScript</strong> é uma linguagem conhecida também por tratar funções como qualquer outro valor. Você pode passar funções como parâmetro, retorná-las de outras funções e atribuí-las à variáveis normalmente. Essa caracterísica é conhecida como <a href="https://developer.mozilla.org/pt-BR/docs/Glossario/Funcao-First-class"><strong>função First-class</strong></a> (ou "<strong>fist-class functions</strong>").</p>
<p>Assim como o motor <strong>JavaScript</strong> registra esses valores em sua memória, ele também cria um contexto onde funções são registradas e podem ser executadas. Como estamos executando esse trecho de código diretamente em um arquivo, sem estar dentro de qualquer escopo, a função <strong>multiplica</strong> estará presente no <strong>contexto global</strong> de execução.</p>
<p>Existem, também, <strong>contextos locais</strong>, que são os responsáveis por guardar funções e variáveis locais à um escopo. Imagine a seguinte alteração na função <strong>multiplica</strong> nosso script:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">multiplica</span> <span class="token punctuation">(</span><span class="token parameter">numero</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> multiplicador <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> numero <span class="token operator">*</span> multiplicador<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Fazendo essa pequena alteração, um novo <strong>contexto de execução</strong> é criado <strong>localmente</strong> para a função <strong>multiplica</strong>, armazenando também o valor 2 dentro da variável <strong>multiplicador</strong>.</p>
<p>Com isso em mente, acredito que você já consegue imaginar que a criação de um contexto dentro de outro pode ser realizada de forma exaustiva.</p>
<p>Vale lembrar que também é nesse instante que o motor <strong>JavaScript</strong> registra o valor correspondente ao <strong>this</strong> presente no escopo da sua função.</p>
<hr>
<h2>Entendendo os componentes do motor</h2>
<h3>Call Stack</h3>
<p>Existe uma <strong>pilha</strong> nos motores <strong>JavaScript</strong> chamada <strong>Call Stack</strong> (ou <strong>pilha de chamadas</strong>, em sua tradução), onde cada chamada à uma função é empilhada ao ser executada e desempilhada ao terminar sua execução.</p>
<p>Executando no seguinte trecho de código, com o <code class="language-text">DevTools</code> aberto:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">terceira</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">debugger</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">segunda</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">terceira</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">primeira</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">segunda</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">primeira</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Você verá algo semelhante à isso:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1200px;"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 49.882075471698116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABkUlEQVQoz3WT23KbMBCGeZImBpyAkTDn2khuECCwwYepJzO56vs/xp9FjlMndS++WRDaT6uVsPhyCRbHyKSAUCU2MkEufxKrj3gho/eCqFWIsQ8w6AW6ysXY+VDiAZX4YbCCJET7dsLw5xXirFCOAsXx5V9OFfKtxE7H+H1I0SkPauPgpXyEkjbJZgYriRNa5YBxd8J+GKFrTbToCH1DR+N1VSMtJJZRjqenAM8eh+dzigwBi8F4AitNUwyT7HjGeBjRtM1d2raFUgpBwDB3XcznLhzbhuPYsGczcM4MVlEUGIY9+n6HftubxKZpTbzSNBdhVVUoBfV6s6HkkOQBGGMmRlGEJZ2HFYYhtNZo6tokXpKbT8l3YRZnSMMMnufBpUqvOI5DVc9hcc6/VvMh+851y6IUdBN+mWoWiwV83zdMVWZZ9ld4T3IXmjvsD2h1h/V6bSR5nhuMcOrB7bam7f+P6XtN87bTbeh6rFYrI7nFHMrUm5p6KKU0q5Zl+YXbsSiKabsRIvoZpmfP800/r7wDCiNQxjYbCFoAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image lazyload"
        alt="CallStack no DevTools do Chrome"
        title="CallStack no DevTools do Chrome"
        data-src="/static/97110456e84c2ff2ac920ffc3f023515/c1b63/call-stack.png"
        data-srcset="/static/97110456e84c2ff2ac920ffc3f023515/5a46d/call-stack.png 300w,
/static/97110456e84c2ff2ac920ffc3f023515/0a47e/call-stack.png 600w,
/static/97110456e84c2ff2ac920ffc3f023515/c1b63/call-stack.png 1200w,
/static/97110456e84c2ff2ac920ffc3f023515/bce1e/call-stack.png 1696w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
    </span></p>
<p>No lado direito do seu <strong>DevTools</strong> ou da imagem, você consegue encontrar a aba <strong>Call Stack</strong>, onde você encontra toda a pilha de chamadas executadas até o ponto onde o breakpoint <code class="language-text">debugger</code> foi executado e logo abaixo a aba <strong>scope</strong> que mantém as variáveis envolvidas naquele escopo (incluindo o <code class="language-text">this</code>!). E o que aconteceu neste momento é o seguinte:</p>
<ul>
<li>a função <code class="language-text">primeira</code> é executada na página em questão pelo motor <strong>JavaScript</strong>, sua execução é a primeira linha (mais abaixo) e, como é executada pelo próprio script, recebe o nome de <strong>(anonymous)</strong></li>
<li>a função <code class="language-text">primeira</code> recebe <code class="language-text">num</code> (com valor 1) como argumento e é empilhada na <strong>call stack</strong>, e retorna a execução da função <code class="language-text">segunda</code> passando <code class="language-text">num + 1</code> como parâmetro</li>
<li>a função <code class="language-text">segunda</code> é executada e executada e recebe <code class="language-text">num</code> (agora valor 2) como argumento, nesse momento, a função é empilhada à <strong>call stack</strong> e retorna a execução da função <code class="language-text">terceira</code> passando <code class="language-text">num + 1</code> como parâmetro</li>
<li>a função <code class="language-text">terceira</code> é executada e empilada à <strong>call stack</strong> recebendo <code class="language-text">num</code> (agora com valor 3) e o <code class="language-text">debugger</code> é executado.</li>
</ul>
<p>Ao executar o <code class="language-text">debugger</code>, é apresentado o estado na qual <strong>call stack</strong> se encontra. Com isso você pode ver as chamadas empilhadas de forma correta e os valores mantidos em <strong>scope</strong>: neste momento <code class="language-text">this</code> refere-se à <code class="language-text">window</code> e <code class="language-text">num</code> é <code class="language-text">3</code>.</p>
<p>Após continuar a execução do <strong>script</strong>, a função <code class="language-text">terceira</code> retorna o valor de <code class="language-text">num + 1</code> (4, ao total) e é desempilhada da <strong>call stack</strong>, após isso, a função <code class="language-text">segunda</code> e <code class="language-text">primeira</code> são desempilhadas em ordem e, por fim, você consegue ver o valor <code class="language-text">4</code> sendo impresso no console.</p>
<p>Talvez você já tenha lido que <strong>JavaScript</strong> segue o paradigma <strong>run-to-completion</strong> (ou "execução até conclusão" traduzido). Isso quer dizer que as funções declaradas na linguagem (com uma exceção, que abordaremos mais abaixo) seguem sua ordem de execução síncronamente até que terminem por completo. Por isso, toda função possui um <code class="language-text">return</code> mesmo que implícito. Tente executar o trecho de código acima com uma pequena alteração:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">terceira</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">segunda</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">terceira</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">primeira</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">segunda</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">primeira</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Apenas removemos o <code class="language-text">console.log</code> que mostra o valor final e o <code class="language-text">return</code> da função <code class="language-text">primeira</code>. Note que agora que no seu console aparecerá uma linha com <code class="language-text">undefined</code> ao final da execução. Isso ocorre porque a função <code class="language-text">primeira</code>, embora tenha chamado a função <code class="language-text">segunda</code> e executado todos os passos como vimos anteriormente, não retornou valor algum explicitamente (ao contrário das funções <code class="language-text">segunda</code> e <code class="language-text">terceira</code>) e, por isso, retorna <code class="language-text">undefined</code> por padrão.</p>
<h4>Maximum call stack size exceeded</h4>
<p>Talvez você já tenha visto o erro <code class="language-text">Maximum call stack size exceeded</code> no seu console. Esse erro ocorre justamente quando um trecho de código empilha funções excessivamente na <strong>call stack</strong>, geralmente por algum trecho recursivo ou que apresente algum loop infinito que faz com que a <strong>pilha de chamadas</strong> "estoure" (nome, inclusive, dado ao famoso fórum "<strong>Stack Overflow</strong>").</p>
<h4>Stack Trace</h4>
<p>Outro comportamento comum é o chamado <code class="language-text">stack trace</code>, que é o rastro de execução das funções até um determinado erro, por exemplo:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">terceira</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ops'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">segunda</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">terceira</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">primeira</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">segunda</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">primeira</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Executando esse trecho você conseguirá visualizar todas as chamadas envolvidas até o momento onde a função disparou um erro, algo como:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1200px;"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 49.882075471698116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABkUlEQVQoz3WT23KbMBCGeZImBpyAkTDn2khuECCwwYepJzO56vs/xp9FjlMndS++WRDaT6uVsPhyCRbHyKSAUCU2MkEufxKrj3gho/eCqFWIsQ8w6AW6ysXY+VDiAZX4YbCCJET7dsLw5xXirFCOAsXx5V9OFfKtxE7H+H1I0SkPauPgpXyEkjbJZgYriRNa5YBxd8J+GKFrTbToCH1DR+N1VSMtJJZRjqenAM8eh+dzigwBi8F4AitNUwyT7HjGeBjRtM1d2raFUgpBwDB3XcznLhzbhuPYsGczcM4MVlEUGIY9+n6HftubxKZpTbzSNBdhVVUoBfV6s6HkkOQBGGMmRlGEJZ2HFYYhtNZo6tokXpKbT8l3YRZnSMMMnufBpUqvOI5DVc9hcc6/VvMh+851y6IUdBN+mWoWiwV83zdMVWZZ9ld4T3IXmjvsD2h1h/V6bSR5nhuMcOrB7bam7f+P6XtN87bTbeh6rFYrI7nFHMrUm5p6KKU0q5Zl+YXbsSiKabsRIvoZpmfP800/r7wDCiNQxjYbCFoAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image lazyload"
        alt="CallStack no DevTools do Chrome"
        title="CallStack no DevTools do Chrome"
        data-src="/static/97110456e84c2ff2ac920ffc3f023515/c1b63/call-stack.png"
        data-srcset="/static/97110456e84c2ff2ac920ffc3f023515/5a46d/call-stack.png 300w,
/static/97110456e84c2ff2ac920ffc3f023515/0a47e/call-stack.png 600w,
/static/97110456e84c2ff2ac920ffc3f023515/c1b63/call-stack.png 1200w,
/static/97110456e84c2ff2ac920ffc3f023515/bce1e/call-stack.png 1696w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
    </span></p>
<p>Ou seja:</p>
<ul>
<li>o script executou a função "primeira"</li>
<li>a função "primeira" foi empilhada e retornou a função "segunda"</li>
<li>a função "segunda" foi empilhada e retornou a função "terceira"</li>
<li>a função "terceira" foi empilhada e, nesse momento, todo esse rastro fica disponível para visualização e o erro é impresso no terminal</li>
</ul>
<h3>APIs envolvidas: lidando com detalhes de implementação</h3>
<p>Além da <strong>Call Stack</strong>, existem outras camadas de <strong>APIs</strong> envolvidas ao rodar <strong>JavaScript</strong>. Funções como <code class="language-text">setTimeout</code>, ou que permitem acesso ao <code class="language-text">DOM</code>, realização de <strong>AJAX</strong> com <code class="language-text">XmlHttpRequest</code> ou até mesmo acesso aos arquivos existentes no disco rígido do computador foram implementadas separadamente e não fazem parte do motor de execução. Essas <strong>APIs</strong> são providas pelo ambiente no qual você executa seu código, podendo ser:</p>
<ul>
<li>Web (nos navegadores)</li>
<li>C++ (no NodeJS)</li>
</ul>
<h4>Web APIs</h4>
<p>São as <strong>APIs</strong> implementadas pelos navegadores (como Google Chrome). Funções de acesso à elementos <code class="language-text">DOM</code> estão presentes apenas ao rodar um código <strong>JavaScript</strong> no navegador (afinal, não existe <code class="language-text">DOM</code> no <strong>NodeJS</strong>).</p>
<h4>C++ APIs</h4>
<p>São as <strong>APIs</strong> providas para o <strong>NodeJS</strong>, já que é escrito em C++. Algumas funções existentes nas APIs web foram reescritas (como o <code class="language-text">setTimeout</code>) e podem ser utilizadas nesse contexto também, mas muitas outras são específicas: como o módulo <code class="language-text">fs</code> responsável por acessar o sistema de arquivos da máquina e realizar operações com dados do disco rígido.</p>
<h3>Task Queue: a fila de tarefas</h3>
<p>A <strong>task queue</strong> (ou <strong>fila de tarefas</strong>), também conhecida como <strong>message</strong> ou <strong>callback</strong> <strong>queue</strong> é a estrutura responsável por armazenar tarefas assíncronas e trabalha em conjunto com a <strong>call stack</strong> e as <strong>APIs</strong> existentes no ambiente em que você roda seu código.</p>
<p>Imagine o seguinte trecho:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">delayLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>O que acontece quando você executa esse exemplo é:</p>
<ul>
<li><code class="language-text">console.log</code> é executado com o valor <code class="language-text">1</code>, empilhado e desempilhado da <strong>call stack</strong> e o valor é exibido no console</li>
<li>a função <code class="language-text">setTimeout</code> (provida pelas <strong>APIs</strong> do seu ambiente) é empilhada na <strong>call stack</strong>, registrando a função <code class="language-text">delayLog</code> como <code class="language-text">callback</code> e pra ser executado apís <code class="language-text">1000</code> milissegundos (1 segundo)</li>
<li>o navegador (ou NodeJS) registra um <code class="language-text">timer</code> com contador de <code class="language-text">1000</code> milissegundos em <code class="language-text">background</code> e continua a execução do código normalmente e a função <code class="language-text">setTimeout</code> é desempilhada da <strong>call stack</strong>, deixando à livre para executar o restante do código</li>
<li>a função <code class="language-text">console.log</code> é executada com valor <code class="language-text">3</code>, empilhada e desempilhada da <strong>call stack</strong> e o valor também é exibido no console</li>
<li>após 1 segundo (<code class="language-text">1000</code> milissegundos) a função <code class="language-text">delayLog</code> é inserida na <strong>call stack</strong> (caso esteja vazia), onde o <code class="language-text">console.log</code> é executado e o valor <code class="language-text">2</code> é impresso no console.</li>
</ul>
<p>Dessa forma, códigos assíncronos (como callbacks do <code class="language-text">setTimout</code>) são registrados e inseridos em uma <strong>fila</strong>, onde são executados posteriormente na ordem em que foram definidos.</p>
<p>É pos isso que, muito provavelmente, você você já tenha visto alguma execução de <code class="language-text">setTimeout</code> da seguinte forma:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>O que acontece nesse caso é que, mesmo a função sendo registrada para ser executada em <code class="language-text">0</code> milissegundos, ela só será executada após ser registrada na <strong>task queue</strong> e ao retornar à <strong>call stack</strong> quando estiver completamente vazia. Fazendo com que o restante do código síncrono execute primeiro.</p>
<p>O mesmo ocorre com os <code class="language-text">listeners</code> de eventos do <code class="language-text">DOM</code>. Quando você registra alguma função, como:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">onClickButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'clicked'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Essa função é registrada na <strong>web API</strong> do navegador em questão e, ao clicar no botão, faz com que essa função entre na <strong>task queue</strong> e, consequentemente, seja empilhada na <strong>call stack</strong> para ser executada e desempilhada.</p>
<p>É inclusive por isso que funções como <code class="language-text">setTimeout</code> e <code class="language-text">setInterval</code>, retornam um valor numérico, servindo de identificador na <strong>task queue</strong> para que você possa cancelá-las caso deseje, tente fazer o seguinte teste:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer 1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer 2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Perceba que apenas <code class="language-text">timer 1</code> aparecerá no console.</p>
<h2>Outras filas do motor</h2>
<p>No entanto, não existe somente um tipo de <strong>fila</strong> nos motores <strong>JavaScript</strong>.</p>
<h3>Microtask Queue</h3>
<p>Com a adição das <strong>Promises</strong> ao <strong>EcmaScript</strong>, esse novo tipo de fila foi inserido nos motores <strong>JavaScript</strong>. É a <strong>fila</strong> responsável por lidar com a execução de <strong>Promises</strong>.</p>
<p>Em outras palavras, cada vez que você executar algum trecho que utilize <strong>Promise</strong>, como:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// lida com a promise</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Essa chamada será <strong>enfileirada</strong> em uma <strong>fila</strong> diferente da <strong>task queue</strong>.</p>
<p>A <strong>microtask queue</strong> possuí alguns comportamentos específicos, tendo uma certa prioridade em relação à <strong>task queue</strong>.</p>
<p>Em um cenário em que existam tarefas enfileiradas na <strong>task queue</strong> e na <strong>microtask queue</strong>, todas que estão na <strong>microtask queue</strong> serão executadas primeiramente.</p>
<p>Isso quer dizer que o motor <strong>JavaScript</strong> que estiver executando uma tarefa vinda da <strong>task queue</strong> finalizará sua execução mas, a próxima tarefa que irá executar será prioritariamente vinda da <strong>microtask queue</strong> até que todas as tarefas dessa fila sejam finalizadas.</p>
<p>Para testar, execute o seguinte código:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'log 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout 1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout 2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'log 2'</span><span class="token punctuation">)</span></code></pre></div>
<p>Perceba que a ordem das informações printadas no console será a seguinte:</p>
<ul>
<li>log 1</li>
<li>log 2</li>
<li>promise 1</li>
<li>promise 2</li>
<li>timeout 1</li>
<li>timeout 2</li>
</ul>
<h3>Animation Frame Callback Queue (ou Animation Queue)</h3>
<p>É a <strong>fila</strong> responsável por conter as tarefas de <code class="language-text">callback</code> ao executar a função <strong>requestAnimationFrame</strong>.
Ao realizar a chamada dessa função, também retornam um número que serve como identificador do <code class="language-text">callback</code> registrado na <strong>fila</strong> onde são armazenados até sua execução (assim como o exemplo anterior do <code class="language-text">setTimeout</code> e do <code class="language-text">setInterval</code>).</p>
<p>Essa <strong>fila</strong> trabalha em conjunto com a <strong>Rendering Pipeline</strong> que é a sequência de processos que o navegador executa para repintar um elemento na tela.</p>
<p>Essa <strong>fila</strong> também possuí um tratamento diferenciado se comparada à <strong>task queue</strong> e à <strong>microtask queue</strong>, de forma que sua execução só se dá início ao finalizar as tarefas das demais filas, entretanto, se novas tarefas dessa <strong>fila</strong> forem <strong>enfileiradas</strong> após o início de sua execução, elas serão executadas somente no próximo <strong>loop</strong> de eventos.</p>
<h2>E o tal do Event Loop?</h2>
<p><strong>Event Loop</strong> é a peça responsável por orquestrar esses componentes em questão. Ele checa se a <strong>call stack</strong> está vazia e não executa mais nenhuma função. Caso esteja, verifica se existe alguma função na <strong>task queue</strong> que deve ser executada e, caso a <strong>call stack</strong> esteja vazia, ele faz com que a tarefa em questão seja executada e empilhada.</p>
<p>Caso a <strong>microtask queue</strong> possua tarefas, elas serão executadas prioritariamente antes das tarefas presentes na <strong>task queue</strong>, mesmo que novas <code class="language-text">Promises</code> sejam enfileiradas ao longo desse processo e, ao finalizar, o motor checará se é necessário realizar algum <code class="language-text">repaint</code> na tela e executará os demais <code class="language-text">callbacks</code> registrados na <strong>animation queue</strong>.</p>
<h2>Iteradores, iteráveis e Geradores</h2>
<p>Outra estrutura de dados que tem um comportamento diferenciado em relação à <strong>call stack</strong> são os iteradores (ou <strong>iterators</strong>) e os <strong>geradores</strong> (ou <strong>function generators</strong>).</p>
<p>Iteradores foram criados para suprir uma forma de iterar valores não-lineares (que não são arrays) e geradores são utilizados para facilitar sua implementação, imagine o seguinte trecho:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> generated <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// cria o iterador e o mantém suspenso</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>generated<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>generated<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>generated<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>generated<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>O asterisco (*) após o nome da função indica que ela é uma função geradora, e cada um dos <code class="language-text">yield</code> é responsável por retornar um valor e "pausar" a execução dessa função, até que próximo <code class="language-text">next</code> seja executado. Ao executarmos a função <code class="language-text">createIterator()</code> e atribuir seu retorno à uma variável, apenas estamos declarando um novo iterador, e a execução da função só é realmente iniciada a partir do primeiro <code class="language-text">next</code> executado.</p>
<p>A cada novo <code class="language-text">next</code>, uma nova função é empilhada na <strong>call stack</strong>, desempilhada e retorna o valor apresentado no <code class="language-text">yield</code>. Nesse momento, todo seu contexto de execução e variáveis de escopo são armazenadas e o objeto gerador mantém uma cópia desses valores para que possa continuar sua execução no futuro. Para visualizar melhor, você pode inserir um <code class="language-text">debugger</code> antes de cada um dos <code class="language-text">yield</code> presente na função acima:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">debugger</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token keyword">debugger</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
    
    <span class="token keyword">debugger</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> generated <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Note que nada aconteceu, mas se você executar <code class="language-text">generated.next()</code> o primeiro <code class="language-text">debugger</code> entrará em ação, assim como os demais conforme sua execução.</p>
<p>Muito parecida essa estrutura com a utilizada pelo <code class="language-text">async/await</code>, não? Os geradores serviram como base para criação dessa estrutura que facilita a escrita de <code class="language-text">Promises</code>, tornando sua leitura mais amigável e dando a sensação de que código assíncrono é executado de forma síncrona.</p>
<h2>Web Workers</h2>
<p><strong>Web Workers</strong> funcionam de maneira igual às execuções de <strong>JavaScript</strong> comum, a única diferença é que são executados em segundo plano (outra thread). Por não rodarem diretamente no navegador, não possuem acesso ao <code class="language-text">DOM</code> e nem são manipulados por eventos de click ou interação de usuários e se comunicam com a thread principal através de eventos de mensagem.</p>
<p>Em resumo, <strong>web workers</strong> possuem sua própria <strong>call stack</strong> com suas <strong>filas</strong> definidas e são recomendados para operações que demandem alto processamento de dados para que não impactem a experiência do usuário ao ocupar a thread principal.</p>
<h2>Exceções no NodeJS</h2>
<p>Todos os conceitos até o momento são aplicados em um ambiente de NodeJS, com exceção da <strong>Animation Frame Callback Queue</strong> e da <strong>Rendering Pipeline</strong>, já que o NodeJS não realiza nenhuma animação ou renderização.</p>
<p>O <strong>Event Loop</strong> do NodeJS também possui algumas particularidades. Enquanto o <strong>Event Loop</strong> de um navegador fica checando as filas e prepara-se para execução das tarefas a todo momento, o do NodeJS realiza sua execução apenas quando existem tarefas a serem executadas.</p>
<p>O NodeJS também possui algumas <strong>filas</strong> diferentes, sendo:</p>
<ul>
<li>uma para eventos de callback (parecida com a <strong>task queue</strong>), para I/O, operações de leitura/escrita em disco</li>
<li><strong>check queue</strong> que rodará todos as tarefas executadas com <code class="language-text">setImmediate</code> (praticamente o mesmo que o <code class="language-text">setTimeout(callback, 0)</code>, mas com prioridade diferente caso alguma operação de I/O esteja ocorrendo)</li>
<li>uma para timers do <code class="language-text">setTimeout</code> e <code class="language-text">setInterval</code></li>
<li>uma <strong>microtask queue</strong> para <code class="language-text">Promises</code></li>
<li>outra <strong>microtask queue</strong> para execução de tarefas imediatas, através do <code class="language-text">process.nextTick()</code>, que possui uma prioridade maior que a <strong>microtask queue</strong> de <code class="language-text">Promises</code></li>
</ul>
<p>Caso queira testar, você pode executar o seguinte trecho via NodeJS:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// arquivo test.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'log 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tick 1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout 1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate 1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tick 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout 2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'log 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Caso você execute <code class="language-text">node test.js</code> você receberá o seguinte como output:</p>
<ul>
<li>log 1</li>
<li>log 2</li>
<li>tick 1</li>
<li>tick 2</li>
<li>promise 1</li>
<li>promise 2</li>
<li>timeout 1</li>
<li>timeout 2</li>
<li>immediate 1</li>
<li>immediate 2</li>
<li>O log dos <code class="language-text">setImmediate</code> podem variar, por não estarem em uma execução de I/O</li>
</ul>
<p>Caso queira testar um evento de I/O e ver a execução do <code class="language-text">setImmediate</code> com prioridade em ação, pode testar com:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Crie um arquivo qualquer e substitua <code class="language-text">__filename</code> pelo seu nome e execute esse trecho.
Você verá que o log exeutado pelo <code class="language-text">setImmediate</code> sempre ocorrerá antes do log de <code class="language-text">setTimeout</code>.</p>
<p>Caso queira checar mais afundo, você pode dar uma olhada na <a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/">documentação</a>.</p>
<h2>Resumo</h2>
<p>Para resumirmos, vale lembrar que os motores <strong>JavaScript</strong> fazem uso dos conceitos de pilha (para a pilha de chamadas) e de fila (para as filas de tarefa, callbacks de promise e de animation). Ao rodar seu código, algumas APIs de ambiente também estão presentes, sejam elas providas pelo navegador (web) ou pelo NodeJS (C++). E o Event Loop é a peça responsável por orquestrar essa execução, checando as filas de tarefa e inserindo essas tarefas na <strong>call stack</strong> quando vazia.</p>
<p>Ao final, podemos imaginar o motor <strong>JavaScript</strong> como:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 485px;"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 101.23711340206185%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAEA0lEQVQ4y22U+1MaVxiG+U/7Q5t2Os20nbZT20mMY2OiTZQabaxGjRmTmabGqMFiJiZqBJUooIAQQRGW+3WBBZdlr2+/3QV0Ojkz75xzlsOz73c5a2EbEvKcilIDKHCaoat7tiFDlRUUEyxKqQpKyUsVSXmGBV8XoA9N02DJc8DCOz/uTb/E5PN1Q9ML72B9/ApPbC5ESyq4hoiQN4WwL2Mo6jfFHGcR86VRKzYugSwPTPy9ji9/vosb96fwy+AEbg1P4/rN+7g7uYhERcMFLyKig4I5nJMigbaOc8ZzrnwFqMPnbbvos85g8OEz3PnzKXpHZtE/+hh/PX9LDhXUL0ScHKUNyGkgi0QohySJCZnAfN4EQgeWLoC5ZSeu91rRMzSF22Pzxvxt3wOMP32NbE2D3JIQ96cJksUZASM6NJglICmQQYVctdS2Qx04vfge13qG8H3/GHqHZ2gex1e/3oN1bhUZAoqCaOQrHS4ifVLAeahgzBnaMxR2nUKWNKAlt4GzSw58fWMYPw5MoO+POWP+hhw/mLcbQIkchr0MQp4YggdROHfO4N+P4iPtw544AS+MiOtk01Kmojx6sYnPf7qD78jhLeus4fRazyBGqNLpqmocnnj0Ep/9cBu/UW776MzA2BN8QYUcHH0GrmK2TVVQYMmRA/veGUG3MLWwgRlqmUkqxvTiFpa3gkiyChRRgWszgLXVPdiWtrBmc8K+4oD9lRM71HIFKor+Wk53yNb1xgZqIpAut7DrOcFZkkWtBegdUKLfZVFCNcuhXmgg7I8gEUlSHmMop1g06Fmt1oSktoFmuVWoqmIsBaFJ1VK7ujo0fHrIJJ6ITZKFKg1T5vEm34SiKOZDGipfgFQ+hVyJQa3FoVRjpmoxqkKCxKBRL6Mp61XuArV2X6ooc0VIstgFxoK76B8awejDKQgxB+XlgyGR1mkPtdXBMkqJAAQKRlYNoNa9Ngy58KUP6XacQtXMFKQiB1hfW8H2xmvIGS+Q90Ej6WsuuotqZBstOs8r7ZvSAYpyC2+9b7DuXofdtYpkjoFI3SqyEWg5F5ScG1LWDSXvIRG4eASU/aRDtGoMWoqZZQPYgaYqCRwlvQjEfeCbvPEsHnJhYHgcN3+fgM/xrwGoftxA3LWMpHsVzN4iklH/5V3uhNspYalSBM/zVG2BHCpgUyHsbNqxvfkG+Qjlr3xMTo8gJD0QUl40mX2IlKru1+ZqDjtrHdYkh4q+5c7pLQfUqOSidGiErBU8FLIXWvGQvsJuqFzc9KP9L+Sra0kUwQsSxFwA0vl7xFwriO0tIe22IbG/gjPnC8Q/0Oz4B7XE4aXDbtN+AqoPvefUnJecBagwPpr9pjrrLLmmonT++x/4dpsrf9RdtwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image lazyload"
        alt="Diagrama sobre os componentes V8"
        title="Diagrama sobre os componentes V8"
        data-src="/static/80fc4966498dfb7b0b4b0029f3602c82/44c61/diagrama.png"
        data-srcset="/static/80fc4966498dfb7b0b4b0029f3602c82/5a46d/diagrama.png 300w,
/static/80fc4966498dfb7b0b4b0029f3602c82/44c61/diagrama.png 485w"
        sizes="(max-width: 485px) 100vw, 485px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
    </span></p>
<p><a href="https://github.com/gabrieluizramos/entrevistas/blob/master/estudos/javascript-engines.md">Links relacionados</a></p></div></article></main><hr/><header class="styles__Footer-sc-120opzy-0 judbns"><a href="/https:/gabrieluizramos.com.br/">@gabrieluizramos</a></header></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-105850294-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/post/entendendo-o-v8-peca-por-peca/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-e93772700260c9e23128.js"],"component---src-templates-post-index-js":["/component---src-templates-post-index-js-0b61b518c22554eaa13a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-b62d83540894bce9fea0.js"],"component---src-pages-index-js":["/component---src-pages-index-js-fdee23ae5008731072f7.js"]};/*]]>*/</script><script src="/webpack-runtime-927d743ab403ea495ffe.js" async=""></script><script src="/styles-07192a3d34f1eb369acc.js" async=""></script><script src="/app-e93772700260c9e23128.js" async=""></script><script src="/commons-ba97eb09b11e7d7faa5b.js" async=""></script><script src="/component---src-templates-post-index-js-0b61b518c22554eaa13a.js" async=""></script></body></html>